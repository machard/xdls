/*! xdls - v0.0.0 - 2014-04-08
* http://www.youtube.com/watch?v=cDuG95DXbw8
* Copyright (c) 2014 Obi-Wan Kenobi; Licensed  */
!function(a,b){"use strict";"function"==typeof define&&define.amd?define([],b):a.xdls=b()}(this,function(){"use strict";var a,b,c,d,e=!1,f=!1,g=0,h=[],i=[],j=[],k={},l="*",m=5e3,n=function(a,b){if(f)throw"xdls init already started";c=a.url,m=a.timeout||5e3,d=b;var e=document.createElement("a");e.href=c;var g={"http:":80,https:443};l=e.protocol+"//"+e.hostname+(e.port&&g[e.protocol]!==parseInt(e.port,10)?":"+e.port:""),o(),q(p())},o=function(){f=window.document.createElement("iframe"),f.style.display="none",window.addEventListener?window.addEventListener("message",function(a){r(a)},!1):window.attachEvent("onmessage",function(a){r(a)}),window.document.body.appendChild(f),f.src=c},p=function(){var a=Storage.prototype||window.localStorage||{},b=function(a){return function(){if(!e)throw"You need to wait until ready callback has fired";return a.apply(null,arguments)}},c=a.setItem,d=a.getItem,f=a.removeItem;return a.setItem=b(v),a.getItem=b(w),a.removeItem=b(x),function(){a.getItem=d,a.setItem=c,a.removeItem=f}},q=function(c){setTimeout(function(){a||(console.warn("unable to connect to xdls remote frame, switching back to classic localStorage"),b=!0,c(),d(new Error("timeout")))},m)},r=function(c){if(c.origin===l&&!b){var g;try{g=JSON.parse(c.data)}catch(c){return}g&&g._is_xds&&(g.ready?(e=f.contentWindow,u({type:"init"})):g.init?(k=g.values,a=!0,d()):(h[g._xds](g.val,g),s()))}},s=function(){for(var a=0,b=i.length;b>a;a++)t(i[0]),i.shift()},t=function(a){return!e||j.indexOf(a.key)>=0?i.push(a):(g++,a._xds=g,j.push(a.key),h[g]=function(){j.splice(j.indexOf(a.key),1)},void u(a))},u=function(a){e.postMessage(JSON.stringify(a),l)},v=function(a,b){k[a]=b,t({type:"set",key:a,val:b})},w=function(a){return t({type:"get",key:a}),k[a]},x=function(a){delete k[a],t({type:"del",key:a})};return n});